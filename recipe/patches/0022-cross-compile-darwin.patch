From 32a1d05a54410887192f540f9d9f058b68a8398e Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Fri, 2 Oct 2020 00:03:12 +0200
Subject: [PATCH 22/27] cross compile darwin

By Isuru Fernando.
---
 Lib/platform.py | 7 ++++++-
 configure       | 8 ++++++--
 setup.py        | 2 +-
 3 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/Lib/platform.py b/Lib/platform.py
index 134fbae6b1..fbf27ac7d3 100755
--- a/Lib/platform.py
+++ b/Lib/platform.py
@@ -411,7 +411,12 @@ def win32_ver(release='', version='', csd='', ptype=''):
 def _mac_ver_xml():
     fn = '/System/Library/CoreServices/SystemVersion.plist'
     if not os.path.exists(fn):
-        return None
+        if 'SDKROOT' in os.environ:
+            fn = os.environ['SDKROOT'] + fn
+            if not os.path.exists(fn):
+                return None
+        else:
+            return None
 
     try:
         import plistlib
diff --git a/configure b/configure
index d4f931c991..3ce400768e 100755
--- a/configure
+++ b/configure
@@ -3744,6 +3744,8 @@ fi
 printf "%s\n" "\"$MACHDEP\"" >&6; }
 
 
+if test -z "${_PYTHON_HOST_PLATFORM}"
+then
 if test "$cross_compiling" = yes; then
 	case "$host" in
 	*-*-linux*)
@@ -3768,6 +3770,7 @@ if test "$cross_compiling" = yes; then
 	esac
 	_PYTHON_HOST_PLATFORM="$MACHDEP${_host_cpu:+-$_host_cpu}"
 fi
+fi
 
 # Some systems cannot stand _XOPEN_SOURCE being defined at all; they
 # disable features if it is defined, without any means to access these
@@ -6801,7 +6804,7 @@ fi
 if test "$cross_compiling" = yes; then
     case "$READELF" in
 	readelf|:)
-	as_fn_error $? "readelf for the host is required for cross builds" "$LINENO" 5
+	#as_fn_error $? "readelf for the host is required for cross builds" "$LINENO" 5
 	;;
     esac
 fi
@@ -10516,7 +10519,7 @@ rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
   conftest.$ac_objext conftest.beam conftest.$ac_ext
 fi
 
-
+    if test -z "${MACOSX_DEFAULT_ARCH}"; then
     if test "${ac_osx_32bit}" = "yes"; then
     	case `/usr/bin/arch` in
     	i386)
@@ -10546,6 +10549,7 @@ fi
     	esac
 
     fi
+    fi
 
     LIBTOOL_CRUFT=$LIBTOOL_CRUFT" -lSystem -lSystemStubs -arch_only ${MACOSX_DEFAULT_ARCH}"
     LIBTOOL_CRUFT=$LIBTOOL_CRUFT' -install_name $(PYTHONFRAMEWORKINSTALLDIR)/Versions/$(VERSION)/$(PYTHONFRAMEWORK)'
diff --git a/setup.py b/setup.py
index 94556655db..e58b040e72 100644
--- a/setup.py
+++ b/setup.py
@@ -83,7 +83,7 @@ def get_platform():
 HOST_PLATFORM = get_platform()
 MS_WINDOWS = (HOST_PLATFORM == 'win32')
 CYGWIN = (HOST_PLATFORM == 'cygwin')
-MACOS = (HOST_PLATFORM == 'darwin')
+MACOS = (HOST_PLATFORM.startswith('darwin'))
 AIX = (HOST_PLATFORM.startswith('aix'))
 VXWORKS = ('vxworks' in HOST_PLATFORM)
 
-- 
2.30.2

