From 32a1d05a54410887192f540f9d9f058b68a8398e Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Fri, 2 Oct 2020 00:03:12 +0200
Subject: [PATCH 22/27] cross compile darwin

By Isuru Fernando.
---
 Lib/platform.py | 7 ++++++-
 configure       | 2 +-
 configure.ac    | 2 +-
 setup.py        | 4 ++--
 4 files changed, 10 insertions(+), 5 deletions(-)

diff --git a/Lib/platform.py b/Lib/platform.py
index 134fbae6b1..fbf27ac7d3 100755
--- a/Lib/platform.py
+++ b/Lib/platform.py
@@ -411,7 +411,12 @@ def win32_ver(release='', version='', csd='', ptype=''):
 def _mac_ver_xml():
     fn = '/System/Library/CoreServices/SystemVersion.plist'
     if not os.path.exists(fn):
-        return None
+        if 'SDKROOT' in os.environ:
+            fn = os.environ['SDKROOT'] + fn
+            if not os.path.exists(fn):
+                return None
+        else:
+            return None
 
     try:
         import plistlib
diff --git a/configure b/configure
index 77ab6ca38a806..7f22cb504bac4 100755
--- a/configure
+++ b/configure
@@ -6199,7 +6199,7 @@ esac
   fi
 fi
 
-if test "$cross_compiling" = yes; then
+if test "$cross_compiling" = yes -a "$ac_sys_system" != "Darwin"; then
     case "$READELF" in
        readelf|:)
        as_fn_error $? "readelf for the host is required for cross builds" "$LINENO" 5
diff --git a/configure.ac b/configure.ac
index c3839a0ccc8b3..4976fb68bf7ec 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1196,7 +1196,7 @@ then
 fi
 
 AC_CHECK_TOOLS([READELF], [readelf], [:])
-if test "$cross_compiling" = yes; then
+if test "$cross_compiling" = yes -a "$ac_sys_system" != "Darwin"; then
     case "$READELF" in
        readelf|:)
        AC_MSG_ERROR([readelf for the host is required for cross builds])
diff --git a/setup.py b/setup.py
index ea7036905b40a..d7c4a03bdfd22 100644
--- a/setup.py
+++ b/setup.py
@@ -973,11 +973,11 @@ def detect_readline_curses(self):
             os.makedirs(self.build_temp)
         # Determine if readline is already linked against curses or tinfo.
         if do_readline:
-            if CROSS_COMPILING:
+            if CROSS_COMPILING and not MACOS:
                 ret = run_command("%s -d %s | grep '(NEEDED)' > %s"
                                 % (sysconfig.get_config_var('READELF'),
                                    do_readline, tmpfile))
-            elif find_executable('ldd'):
+            elif find_executable('ldd') and not MACOS:
                 ret = run_command("ldd %s > %s" % (do_readline, tmpfile))
             else:
                 ret = 1
--
